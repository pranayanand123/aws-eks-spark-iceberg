# AWS EKS Spark Iceberg Data Pipeline Architecture

## Overview
This is a comprehensive log processing data pipeline that uses Apache Spark on Amazon EKS (Kubernetes) to process nginx logs, store them in Apache Iceberg format using Apache Hive Metastore, with data stored in Amazon S3. The entire infrastructure is deployed using Terraform.

---

## Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│                                              AWS CLOUD ENVIRONMENT                                                  │
├─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┤
│                                                                                                                     │
│  ┌─────────────────┐    ┌──────────────────────────────────────────────────────────────────────────────────────┐ │
│  │   DATA SOURCE   │    │                            AMAZON S3 STORAGE                                        │ │
│  │                 │    │                                                                                      │ │
│  │ ┌─────────────┐ │    │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────────────────────────┐ │ │
│  │ │ Log         │ │────┼─→│  Input Data     │  │  Processed      │  │    Iceberg Warehouse               │ │ │
│  │ │ Generator   │ │    │  │  Bucket         │  │  Data Bucket    │  │    (spark-eks-cluster-warehouse)   │ │ │
│  │ │ (Python)    │ │    │  │ (nginx logs)    │  │ (transformed)   │  │                                     │ │ │
│  │ └─────────────┘ │    │  └─────────────────┘  └─────────────────┘  │  ┌─────────────────────────────────┐ │ │
│  └─────────────────┘    │                                             │  │         Tables:                  │ │ │
│                         │                                             │  │  • access_logs (partitioned)      │ │ │
│                         │                                             │  │  • daily_top_ips                  │ │ │
│  ┌─────────────────┐    │                                             │  │  • daily_top_devices              │ │ │
│  │   TERRAFORM     │    │                                             │  │  • weekly_top_ips                 │ │ │
│  │   INFRASTRUCTURE│    │                                             │  │  • weekly_top_devices             │ │ │
│  │                 │    │                                             │  │                                   │ │ │
│  │ ┌─────────────┐ │    │                                             │  └─────────────────────────────────┘ │ │
│  │ │ • VPC       │ │    │                                             └─────────────────────────────────────┘ │ │
│  │ │ • EKS       │ │    └──────────────────────────────────────────────────────────────────────────────────────┘ │
│  │ │ • RDS       │ │                                                                                               │
│  │ │ • S3        │ │                                                                                               │
│  │ │ • IAM       │ │    ┌──────────────────────────────────────────────────────────────────────────────────────┐ │
│  │ └─────────────┘ │    │                              AMAZON EKS CLUSTER                                      │ │
│  └─────────────────┘    │                                                                                      │ │
│                         │  ┌─────────────────────────────────────────────────────────────────────────────────┐ │ │
│                         │  │                            SPARK CLUSTER                                       │ │ │
│  ┌─────────────────┐    │  │                                                                                 │ │ │
│  │   AMAZON RDS    │    │  │  ┌─────────────────┐                    ┌─────────────────────────────────────┐ │ │ │
│  │   POSTGRESQL    │◄───┼──┼──┤  Spark Master   │                    │         Spark Workers               │ │ │ │
│  │                 │    │  │  │   (1 replica)   │◄──────────────────►│         (3 replicas)               │ │ │ │
│  │ ┌─────────────┐ │    │  │  │                 │                    │                                     │ │ │ │
│  │ │   Hive      │ │    │  │  │ • Spark UI      │                    │ • Spot instances (t3.medium)       │ │ │ │
│  │ │ Metastore   │ │    │  │  │ • Job Scheduler │                    │ • Auto-scaling (3-6 nodes)         │ │ │ │
│  │ │ Database    │ │    │  │  │ • Resource Mgmt │                    │ • Dedicated node group             │ │ │ │
│  │ │             │ │    │  │  └─────────────────┘                    │ • Taint/Toleration based scheduling│ │ │ │
│  │ │ • Tables    │ │    │  │                                         └─────────────────────────────────────┘ │ │ │
│  │ │ • Schemas   │ │    │  │                                                                                 │ │ │
│  │ │ • Metadata  │ │    │  └─────────────────────────────────────────────────────────────────────────────────┘ │ │
│  │ └─────────────┘ │    │                                                                                      │ │
│  └─────────────────┘    │  ┌─────────────────────────────────────────────────────────────────────────────────┐ │ │
│                         │  │                        HIVE METASTORE SERVICE                                   │ │ │
│                         │  │                                                                                 │ │ │
│                         │  │  ┌─────────────────────────────────────────────────────────────────────────────┐ │ │ │
│                         │  │  │                    Hive Metastore Pod                                      │ │ │ │
│                         │  │  │                                                                             │ │ │ │
│                         │  │  │  • Thrift Server (port 9083)                                               │ │ │ │
│                         │  │  │  • PostgreSQL JDBC Connection                                              │ │ │ │
│                         │  │  │  • S3 Configuration for Warehouse                                          │ │ │ │
│                         │  │  │  • Schema Management                                                       │ │ │ │
│                         │  │  │  • Table Metadata Management                                               │ │ │ │
│                         │  │  └─────────────────────────────────────────────────────────────────────────────┘ │ │ │
│                         │  └─────────────────────────────────────────────────────────────────────────────────┘ │ │
│                         └──────────────────────────────────────────────────────────────────────────────────────┘ │
│                                                                                                                     │
└─────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
```

---

## Data Flow

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│    1.       │    │    2.       │    │    3.       │    │    4.       │    │    5.       │
│  Generate   │───▶│   Upload    │───▶│ Process Logs│───▶│   Store     │───▶│  Analytics  │
│    Logs     │    │   to S3     │    │   in Spark  │    │  in Iceberg │    │  & Reports  │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```
